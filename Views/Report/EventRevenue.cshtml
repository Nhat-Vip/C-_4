@model IEnumerable<dynamic>

<div class="container mt-4" style="height: 100vh;">
    <h3>Báo cáo doanh thu sự kiện</h3>
    <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm sự kiện..." onkeyup="FindEventRevenue()">
    </div>
    <div class="overflow-auto" style="max-height: 75vh;">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Tên sự kiện</th>
                    <th>Doanh thu</th>
                    <th>Số vé đã bán</th>
                    <th>Chi tiết</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ev in Model)
                {
                    <tr>
                        <td>@ev.EventName</td>
                        <td>@ev.TotalRevenue.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</td>
                        <td>@ev.TotalTicketsSold</td>
                        <td>
                            <button class="btn btn-primary btn-sm"
                                    onclick="loadDetail(@ev.EventId, '@ev.EventName')">
                                Xem chi tiết
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
    <div class="d-flex justify-content-end">
        <span class="text-black fw-bold">Tổng doanh thu: @Model.Sum(s=>(decimal)s.TotalRevenue).ToString("C0", new
                        System.Globalization.CultureInfo("vi-VN"))</span>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết doanh thu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailContent">Đang tải...</div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function loadDetail(eventId, eventName) {
            document.querySelector("#detailModal .modal-title").innerText =
                "Chi tiết doanh thu - " + eventName;
            document.getElementById("detailContent").innerHTML = "Đang tải...";

            fetch(`/Report/EventRevenueDetail?eventId=${eventId}`)
                .then(res => res.json())
                .then(data => {
                    let html = "";
                    data.forEach(st => {
                        html += `<h6>Suất chiếu: ${new Date(st.showTime).toLocaleString()}</h6>`;
                        html += `<table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Nhóm ghế</th>
                                            <th>Giá</th>
                                            <th>Vé đã bán</th>
                                            <th>Doanh thu</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                        st.groups.forEach(g => {
                            html += `<tr>
                                        <td>${g.name}</td>
                                        <td>${g.price.toLocaleString()} đ</td>
                                        <td>${g.ticketsSold}</td>
                                        <td>${(g.price * g.ticketsSold).toLocaleString()} đ</td>
                                    </tr>`;
                        });
                        html += `</tbody></table>`;
                    });
                    document.getElementById("detailContent").innerHTML = html;
                });

            new bootstrap.Modal(document.getElementById("detailModal")).show();
        }
        function FindEventRevenue() {
            const searchValue = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const eventName = row.cells[0].innerText.toLowerCase();
                if (eventName.includes(searchValue)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }
    </script>
}
